worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # 上流（Coraza/Go）— 既存
    upstream coraza_backend {
        ${NGX_CORAZA_UPSTREAM}
    }

    ##
    ## Proxy Cache 設定
    ##
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=mamo:50m
                     max_size=2g inactive=30m use_temp_path=off;

    # メソッド種別
    map $request_method $is_get {
        default 0;
        GET     1;
        HEAD    1;
    }

    # 上流からの合図（Coraza → ModifyResponse で付与）
    map $upstream_http_x_mamotama_cacheable $mamo_cacheable {
        default 0;
        "1"     1;
    }

    # 認証・Cookie 付きはキャッシュ禁止
    map $http_authorization $has_auth {
        default 0;
        ~.+:    1;
    }
    map $http_cookie $has_cookie {
        default 0;
        ~.+:    1;
    }

    # /mamotama-api/ は常に非キャッシュ
    map $request_uri $is_api {
        default                         0;
        ~^${NGX_CORAZA_API_BASEPATH}    1;
    }

    # 総合判定（1 なら no-cache / cache-bypass）
    map "$is_get$has_auth$has_cookie$mamo_cacheable$is_api" $mamo_nocache {
        # GET/HEAD 以外
        ~^0               1;
        # 認証 or Cookie あり
        ~^1(1|0)1         1;
        ~^1(0|1)1         1;
        # 上流合図なし
        ~^1..0.           1;
        # API
        ~^....1           1;
        default           0;
    }

    server {
        listen 80;

        ##
        ## 静的/アプリへのプロキシ
        ##
        location / {
            proxy_pass http://coraza_backend;
            proxy_set_header Host              $http_host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        "upgrade";
            proxy_read_timeout ${NGX_BACKEND_RESPONSE_TIMEOUT};

            proxy_cache            mamo;
            proxy_cache_key        "$scheme://$host$request_uri";
            proxy_cache_valid      200 301 302 10m;
            proxy_cache_valid      404 1m;
            proxy_ignore_headers   Set-Cookie;
            proxy_cache_use_stale  error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;

            proxy_no_cache         $mamo_nocache;
            proxy_cache_bypass     $mamo_nocache;
        }

        ##
        ## 管理UI
        ##
        location ${NGX_CORAZA_ADMIN_URL} {
            proxy_pass http://web:5173;
            proxy_set_header Host              $http_host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        "upgrade";
            proxy_read_timeout ${NGX_BACKEND_RESPONSE_TIMEOUT};

            proxy_no_cache     1;
            proxy_cache_bypass 1;
        }
    }

    resolver 8.8.8.8;
}
