FROM golang:1.23-alpine AS builder

WORKDIR /app

RUN apk add --no-cache git

COPY src .
RUN go mod tidy
RUN go mod download

RUN go build -o server /app/cmd/server

FROM alpine:3.19

ARG WAF_APP_URL
ENV WAF_APP_URL=${WAF_APP_URL}
ARG WAF_LOG_FILE
ENV WAF_LOG_FILE=${WAF_LOG_FILE}
ARG WAF_STRICT_OVERRIDE
ENV WAF_STRICT_OVERRIDE=${WAF_STRICT_OVERRIDE}
ARG WAF_ADMIN_BASEPATH
ENV WAF_ADMIN_BASEPATH=${WAF_ADMIN_BASEPATH}
ARG WAF_BYPASS_FILE
ENV WAF_BYPASS_FILE=${WAF_BYPASS_FILE}
ARG WAF_RULES_FILE
ENV WAF_RULES_FILE=${WAF_RULES_FILE}

WORKDIR /app

COPY --from=builder /app/server .

EXPOSE 9090

CMD ["/app/server"]
